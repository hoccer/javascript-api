<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Hoccer Webclient</title>
	<meta name="generator" content="TextMate http://macromates.com/">
	<meta name="author" content="Robert Palmer">
	<!-- Date: 2010-12-15 -->
	<script src="lib/jquery-1.4.4.min.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	
	<script src="lib/base.js" type="text/javascript" charset="utf-8"></script>
	<script src="lib/linccer.js" type="text/javascript" charset="utf-8"></script>
	<script src="lib/filecache.js" type="text/javascript" charset="utf-8"></script>
	
	<script type="text/javascript" charset="utf-8">
		var WebClient = function() {
			that = {};
			HC.observable(that);
						
			$("#sendButton").click(function() { that.fire('send'); } );
			$("#receiveButton").click(function() {that.fire('receive') } );
			
			that.enableSend = function() {
			};
			
			that.enableReceive = function() {
			};
			
			that.displayLocation = function(location) {
				$("#waiting").css("display", "none");
				$("#coordinates").css("display", "inline");
			};
			
			that.showUploadingState = function() {
				// $("#").css("display": "none");	
			};
			
			that.uploadReady = function() {
				
			}
			
			return that;
		}
	
	
		$(document).ready(function() {
			console.log("loaded");
			
			var fileCache = FileCache();			
			var linccer = Linccer( {'api_key' : '1234567890'});
		  var client = WebClient();
		  
		  client.on('send', function() {
				console.log('sending');
				var content = document.getElementById("input").value;
				var data = [
				   {
						"type": "text/plain",
						"content": content
						}
				];

				linccer.send("one-to-many", data);
				
			});

			client.on('receive', function() {
				linccer.receive("one-to-many")
			});
			
			fileCache.on('started', function(url) {
				console.log('started:' + url);
			});
			
			fileCache.on('progress', function(progress) {
				console.log(progress);
			});

			fileCache.on('uploaded', function(uri) {
		    console.log("uploaded: " + uri);
			});
			
			
			linccer.on('sent', function(data) {
				console.log("sent!!!!!! " + data);
			});
			
			linccer.on('ready', function() {
				client.displayLocation();
			})
			
			linccer.on('updated_environment', function(data) {
				console.log('updated environments!!!!!');
			});
			
			linccer.on('received', function(data) {
				console.log(data);
				document.getElementById("input").value = data[0][0].content;
			});
			
			linccer.on('error', function(error) {
				console.log(error);
			});
			
			if (navigator.geolocation) {
	      navigator.geolocation.getCurrentPosition(function(position) {
	        console.log(position.coords.latitude + " " + position.coords.longitude);

	        linccer.setEnvironmentCoordinates(position.coords.latitude, 
	          position.coords.longitude, position.coords.accuracy, position.timestamp);
	
					$("#coordinates").html( position.coords.latitude + " " + position.coords.longitude );
	      },
	      function(error) {
	        console.log("error:" + error.message);
	      }
	      , {maximumAge:Infinity}); 
	    }
			
			$("#fileInputField").change(function() {
				var file = document.getElementById('fileInputField').files[0];
				fileCache.upload(file);
			});
		});
		

		
	</script>
	
	<style type="text/css" media="screen">
	
		#content { width: 500px; margin: 0 auto}
		#content div { margin-top: 20px;}
		#location #coordinates { display: none; }
	</style>
	
</head>
<body>

	<div id="content">
		<div id="location">
			<span id="waiting">locating...</span>
			<span id="coordinates">32,12 1212</span>
		</div>

		<div>			
			File: <input id="fileInputField" type="file" name="upload[filename]" />
		</div>
		<div>
			<a href="#" id="receiveButton">Receive</a>
			<a href="#" id="sendButton">Send</a>
		</div>



</div>
</body>
</html>
