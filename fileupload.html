<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Test</title>
	<meta name="generator" content="TextMate http://macromates.com/">
	<meta name="author" content="Robert Palmer">
	<!-- Date: 2010-12-15 -->
	<script src="lib/jquery-1.4.4.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" charset="utf-8">
		// if (navigator.geolocation) {
		//   navigator.geolocation.watchPosition(function(position) {
		// 	console.log(position.coords.latitude + " " + position.coords.longitude);
		//   }); 
		// }
		var load = function(scriptName) {
			console.log("loading " + scriptName);
			
			var script = document.createElement("script");
			script.setAttribute("type", "text/javascript");
			script.setAttribute("src", scriptName);
			
			document.body.appendChild(script);
		}
		
		var Linccer = function() {
			var that = this;
			var latitude, longitude;
			
			var updateEnvironment = function() {
				setTimeout(updateEnvironment, 25 * 1000);
				if (that.latitude == null || that.longitude == null) {
					return;
				}
				
				load("http://localhost:4567/clients/" + uuid + "/environment.js" +
														"?latitude=" + that.latitude 
													 + "&longitude=" + that.longitude
													// preventing caching by adding timestamp
													       + "&time=" + new Date().getTime()); 
			}
			
			var randomUUID = function() {
			  var s = [], itoh = '0123456789ABCDEF';

			  // Make array of random hex digits. The UUID only has 32 digits in it, but we
			  // allocate an extra items to make room for the '-'s we'll be inserting.
			  for (var i = 0; i <36; i++) s[i] = Math.floor(Math.random()*0x10);

			  // Conform to RFC-4122, section 4.4
			  s[14] = 4;  // Set 4 high bits of time_high field to version
			  s[19] = (s[19] & 0x3) | 0x8;  // Specify 2 high bits of clock sequence

			  // Convert to hex chars
			  for (var i = 0; i <36; i++) s[i] = itoh[s[i]];

			  // Insert '-'s
			  s[8] = s[13] = s[18] = s[23] = '-';

			  return s.join('');
			}
			
			that.uuid = randomUUID();
			
			that.onReceived = function(data) {
				console.log(data.content);
			}
			
			that.onSend = function(data) {
				console.log("send");
			}
						
			that.setEnvirenmentCoordinates = function(latitude, longitude, accuracy) {				
				that.latitude = latitude;
				that.longitude = longitude; 
				
				updateEnvironment();
			}
			
			that.send = function(mode, data) {
				var send = { "data" : data }
				load("http://localhost:4567/clients/" + uuid + "/action/send.js?mode=" + mode
												 + "&" + $.param(send));
			}
			
			that.receive = function(mode) {
				load("http://localhost:4567/clients/" + uuid + "/action/receive.js?mode=" + mode);
			}
			
			return that;	
		}
		
		window.onload = function() {
			linccer = Linccer();
			linccer.setEnvirenmentCoordinates(13, 45, 100);
		}
		
		function receive_action() {
			linccer.receive("one-to-one")
		}
		
		function send_action() {
			var data = [
					{
						"type": "text/plain",
						"content": "Hallo" 
					}
				];
				 
			linccer.send("one-to_one", data);
		}
		
	</script>
</head>
<body>
<form method="POST" action="http://filecache.beta.hoccer.com/?expires_in=120">
	File: <input type="file" name="upload[filename]" />
	<input type="submit" />
	
	<a href="javascript:receive_action()">Receive</a>
	<a href="javascript:send_action()">Send</a>
	
</form>



</body>
</html>
